<!DOCTYPE html>
<html>
  <head>
    <title>Landing Page</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
            type="application/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="bundle.js" , type="text/javascript"></script>

    <style>
    body {
        background-color: #f5f5f5;
      }
      h1 {
        color: #333;
        font-size: 3rem;
        font-weight: 600;
        text-align: center;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: #fff;
        font-weight: 600;
        text-transform: uppercase;
      }
      .btn-primary:hover,
      .btn-primary:focus {
        background-color: #0062cc;
        border-color: #0062cc;
        color: #fff;
      }
      label {
        font-weight: 600;
      }

      .user-address {
        background-color: #fff;
        border: 2px solid #007bff;
        border-radius: 5px;
        color: #333;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 1rem;
        padding: 1rem;
        text-align: center;
        word-wrap: break-word;
      }
    </style>

  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-md-6 offset-md-3">
          <h1 class="text-center mb-4">Stealth Wallet</h1>
          <p class="text-center mb-4">Connect your Metamask wallet and sign a message</p>
          <div class="form-group">
            <button id="connect-wallet-btn" class="btn btn-primary btn-block">Connect Wallet</button>
          </div>
          <div id="user-address" class="user-address d-none"></div>

          <div id="login">
            <div class="form-group">
              <label for="message-input">Message to sign:</label>
              <textarea id="message-input" class="form-control" rows="3">Sign this message to login into you stealth wallet on Ethereum mainnet.</textarea>
            </div>
            <div class="form-group">
              <button id="sign-message-btn" class="btn btn-primary btn-block">Sign Message</button>
            </div>
          </div>
        </div>
      </div>
      <div id="personalSign"></div>

    <div id="user-stealth-meta-address" class="d-none">
        <div class="row">
          <div class="col-md-6 offset-md-3">
            <h4 class="text-center mb-4">Your Stealth Meta-Address:</h4>
            <div id="userstealthmetaaddress" class="user-address"></div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 offset-md-3">
            <div class="col px-0">
              <button id="tab1-btn" type="button" class="btn btn-primary w-100">Send</button>
            </div>
            <div class="col px-0">
              <button id="tab2-btn" type="button" class="btn btn-secondary w-100">Receive</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 offset-md-3">

           <!-- Tab content -->
           <div id="tab1" class="tab-content">
             <h2>Tab 1</h2>
             <p>This is the content for Tab 1.</p>
           </div>
           <div id="tab2" class="tab-content" style="display: none;">
             <h2>Tab 2</h2>
             <p>This is the content for Tab 2.</p>
           </div>
         </div>
       </div>
    </div>
</div>


    <!-- Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Custom JS -->
    <script>
      window.onload = function() {
        const web3 = new Web3(window.ethereum);
        const userAddressElement = document.getElementById('user-address');
        const interactionElements = document.getElementById('user-stealth-meta-address');
        const userStealthMetaAddressElement = document.getElementById('userstealthmetaaddress');
        const loginPage = document.getElementById('login');

        document.getElementById('tab1-btn').addEventListener('click', function () {
          document.getElementById('tab1').style.display = 'block';
          document.getElementById('tab2').style.display = 'none';
          document.getElementById('tab1-btn').classList.add('btn-primary');
          document.getElementById('tab1-btn').classList.remove('btn-secondary');
          document.getElementById('tab2-btn').classList.add('btn-secondary');
          document.getElementById('tab2-btn').classList.remove('btn-primary');
        });

        document.getElementById('tab2-btn').addEventListener('click', function () {
          document.getElementById('tab1').style.display = 'none';
          document.getElementById('tab2').style.display = 'block';
          document.getElementById('tab1-btn').classList.add('btn-secondary');
          document.getElementById('tab1-btn').classList.remove('btn-primary');
          document.getElementById('tab2-btn').classList.add('btn-primary');
          document.getElementById('tab2-btn').classList.remove('btn-secondary');
        });

        // Connect Wallet button
        document.getElementById('connect-wallet-btn').addEventListener('click', async function() {
          // Check if Metamask is installed
          if (typeof window.ethereum !== 'undefined') {
            console.log('Metamask is installed!');
            try {
              // Connect to Metamask and get accounts
              const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
              const account = accounts[0];
              console.log('Connected to Metamask!');
              console.log('Current account:', account);
              userAddressElement.innerHTML = `Connected as: ${accounts[0]}`;
              userAddressElement.classList.remove('d-none');
            } catch (error) {
              console.log('Metamask connection error:', error);
            }
          } else {
            console.log('Metamask is not installed!');
          }
        });
        // Sign Message button
        document.getElementById('sign-message-btn').addEventListener('click', async function (event) {
          event.preventDefault();
          const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          const account = accounts[0];
          const exampleMessage = 'Sign this message to login into you stealth wallet on Ethereum mainnet.';
          try {
            const from = accounts[0];
            const hexString = web3.utils.utf8ToHex(exampleMessage);
            const msg = `0x${hexString.slice(2)}`;
            const signature = await ethereum.request({
              method: 'personal_sign',
              params: [msg, from],
            });
            const sig1 = signature.slice(2, 66);
            const sig2 = signature.slice(66, 130);
            console.log(sig1);
            console.log(sig2);

            // Hash "v" and "r" values using SHA-256
           const hashedV = ethers.utils.sha256("0x"+sig1);
           const hashedR = ethers.utils.sha256("0x"+sig2);

           const n = ethers.BigNumber.from('0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141');

          // Calculate the private keys by taking the hash values modulo the curve order
          const privateKey1 = ethers.BigNumber.from(hashedV).mod(n);
          const privateKey2 = ethers.BigNumber.from(hashedR).mod(n);

          // Generate the key pairs
          const keyPair1 = new ethers.Wallet(privateKey1.toHexString());
          const keyPair2 = new ethers.Wallet(privateKey2.toHexString());

           const spendingPublicKey = ethers.utils.computePublicKey(keyPair1.privateKey, true);
           const viewingPublicKey = ethers.utils.computePublicKey(keyPair2.privateKey, true);

           userStealthMetaAddressElement.innerHTML = `st:eth:${spendingPublicKey}${viewingPublicKey.slice(2,)}`;
           interactionElements.classList.remove('d-none');
           loginPage.classList.add('d-none');


          } catch (err) {
            console.error(err);
            personalSign.innerHTML = `Error: ${err.message}`;
          }
        });
      };
    </script>
  </body>
</html>
